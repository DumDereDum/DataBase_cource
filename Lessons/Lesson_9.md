# Триггеры

Триггеры (triggers) в PostgreSQL - это специальные функции, которые выполняются автоматически при определенных событиях, происходящих в таблицах базы данных. Эти события могут быть, например, вставка (INSERT), обновление (UPDATE) или удаление (DELETE) записей в таблице. 

Вот основные моменты, которые стоит учитывать о триггерах в PostgreSQL:

1. **Создание триггера**: Триггеры создаются с помощью SQL-команды `CREATE TRIGGER`. При создании триггера указывается, на какие события он должен реагировать (например, BEFORE INSERT, AFTER UPDATE), а также какая функция должна быть вызвана при возникновении события.

2. **Функция триггера**: Это пользовательская функция, которая выполняется при срабатывании триггера. Функция определяется отдельно от создания триггера и может содержать любой код на PL/pgSQL или другом поддерживаемом языке, включая SQL.

3. **Виды триггеров**: В PostgreSQL существует несколько видов триггеров: BEFORE, AFTER и INSTEAD OF. Триггер BEFORE выполняется до выполнения операции, AFTER - после выполнения операции, а INSTEAD OF позволяет заменить стандартную операцию на свою собственную.

4. **Стандартные переменные**: Внутри функции триггера доступны специальные переменные, такие как `NEW` и `OLD`, которые содержат новое и старое значения соответственно (для триггеров UPDATE).

5. **Управление триггерами**: Триггеры могут быть включены или отключены с помощью команды ALTER TRIGGER. Они также могут быть удалены с помощью команды DROP TRIGGER.

Пример создания триггера, который автоматически обновляет время изменения записи в таблице:

```sql
CREATE OR REPLACE FUNCTION update_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.modified_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_table_modified
BEFORE UPDATE ON your_table
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();
```

Этот триггер будет вызываться перед обновлением каждой строки в таблице `your_table` и обновлять значение `modified_at` на текущее время.

Триггеры в PostgreSQL могут быть мощным инструментом для обеспечения целостности данных и автоматизации определенных действий в базе данных. Однако, их следует использовать осторожно, чтобы избежать ненужной сложности и неожиданного поведения в системе.

## Пример

Хорошо, давайте создадим простую таблицу и добавим триггер для неё. Допустим, мы создадим таблицу для хранения информации о пользователях, и хотим, чтобы при каждом обновлении информации о пользователе, автоматически об

новлялась дата последнего изменения.

Вот SQL-код для создания таблицы пользователей и триггера:

```sql
-- Создание таблицы пользователей
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    last_modified TIMESTAMP
);

-- Создание функции для обновления даты последнего изменения
CREATE OR REPLACE FUNCTION update_last_modified()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_modified = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Создание триггера, который будет вызывать функцию update_last_modified перед обновлением строки в таблице пользователей
CREATE TRIGGER update_user_last_modified
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_last_modified();
```

В данном примере:

1. Мы создали таблицу `users` с полями `user_id`, `username`, `email` и `last_modified`.
2. Для отслеживания последнего изменения мы добавили поле `last_modified` типа `TIMESTAMP`.
3. Создали функцию `update_last_modified()`, которая обновляет поле `last_modified` на текущее время при каждом обновлении записи.
4. Создали триггер `update_user_last_modified`, который вызывает функцию `update_last_modified()` перед обновлением строки в таблице `users`.

Теперь давайте рассмотрим, как это будет работать на практике:

```sql
-- Вставляем данные в таблицу
INSERT INTO users (username, email) VALUES ('john_doe', 'john@example.com');

-- Выбираем данные из таблицы
SELECT * FROM users;

-- Обновляем информацию о пользователе
UPDATE users SET email = 'john.doe@example.com' WHERE user_id = 1;

-- Снова выбираем данные из таблицы, чтобы увидеть изменения
SELECT * FROM users;
```

После выполнения этих команд вы увидите, что поле `last_modified` в записи пользователя было автоматически обновлено при обновлении записи. Таким образом, мы использовали триггер для автоматического обновления времени последнего изменения при каждом обновлении записи в таблице.
